<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kaisei+Decol&display=swap" rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho&display=swap"
    rel="stylesheet">
  <meta charset="UTF-8">
  <title>星空カレンダー</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/mood-calendar.css">
</head>
<body>
  <img src="images/haikei.webp" alt="背景画像" class="background-img">
  
  <div class="calendar-container">
    <!-- ヘッダー -->
    <div class="calendar-header">
      <a href="5-home.html" class="home-link">
        <img src="images/home.png" alt="ホーム" class="home-icon">
      </a>
      <div class="month-selector">
        <button class="month-btn" onclick="changeMonth(-1)">◀</button>
        <span class="current-month" id="currentMonth">2025年1月</span>
        <button class="month-btn" onclick="changeMonth(1)">▶</button>
      </div>
    </div>

    <!-- カレンダー本体 -->
    <div class="calendar-wrapper">
      <div class="calendar-grid" id="calendarGrid">
        <div class="calendar-day-header">日</div>
        <div class="calendar-day-header">月</div>
        <div class="calendar-day-header">火</div>
        <div class="calendar-day-header">水</div>
        <div class="calendar-day-header">木</div>
        <div class="calendar-day-header">金</div>
        <div class="calendar-day-header">土</div>
        
        <!-- カレンダーの日付がここに動的に追加される -->
      </div>
    </div>
  </div>

  <!-- モーダルウィンドウ -->
  <div class="modal-overlay" id="modalOverlay" style="display: none;" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="modal-close-btn" onclick="closeModal()">×</button>
      <div class="modal-date" id="modalDate">2025年1月1日</div>
      <div class="modal-mood">
        <span class="modal-star" id="modalStar">★</span>
        <span class="modal-mood-name" id="modalMoodName">嬉しい</span>
      </div>
      <div class="modal-note" id="modalNote">今日はとても良い日でした！</div>
    </div>
  </div>

  <script src="js/stars.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // 認証チェック
    if (!isLoggedIn()) {
      alert('ログインが必要です');
      window.location.href = '4-login.html';
    }

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1; // 1-12
    let moodData = {}; // { '2025-01-15': { mood: 'happy', note: '...' } }

    // 気分の設定（星の色に対応）
    const MOOD_CONFIG = {
      happy: { name: '嬉しい', color: '#FF0000' },      // 赤
      excited: { name: 'わくわく', color: '#FFD700' },  // 黄色
      peaceful: { name: '穏やか', color: '#FFA500' },   // オレンジ
      tired: { name: '疲れた', color: '#87CEEB' },      // 水色
      sad: { name: '悲しい', color: '#4169E1' },        // 青
      anxious: { name: '不安', color: '#9370DB' }       // 紫
    };

    // 月を変更
    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
      } else if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
      }
      loadCalendar();
    }

    // カレンダーを読み込み
    async function loadCalendar() {
      // 月表示を更新
      document.getElementById('currentMonth').textContent = `${currentYear}年${currentMonth}月`;

      // 気分データを取得
      await fetchMoodData();

      // カレンダーを描画
      renderCalendar();
    }

    // 気分データを取得
    async function fetchMoodData() {
      try {
        const token = localStorage.getItem('token');
        console.log('=== 気分データ取得開始 ===');
        console.log('リクエストURL:', `http://localhost:3000/api/mood/month/${currentYear}/${currentMonth}`);
        
        const response = await fetch(
          `http://localhost:3000/api/mood/month/${currentYear}/${currentMonth}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          }
        );

        console.log('レスポンスステータス:', response.status);

        if (response.ok) {
          const result = await response.json();
          console.log('APIレスポンス:', result);
          
          // データを日付キーで保存
          moodData = {};
          result.data.forEach(record => {
            console.log('record_date:', record.record_date, 'mood:', record.mood);
            moodData[record.record_date] = {
              mood: record.mood,
              note: record.note
            };
          });
          
          console.log('整形後のmoodData:', moodData);
        } else {
          console.error('APIエラー:', response.status);
        }
      } catch (error) {
        console.error('気分データ取得エラー:', error);
      }
    }

// カレンダーを描画
function renderCalendar() {
  const gridContainer = document.getElementById('calendarGrid');
  
  console.log('=== カレンダー描画開始 ===');
  console.log('現在の月:', currentYear, currentMonth);
  console.log('取得した気分データ:', moodData);
  
  // ヘッダー以外を削除
  const headers = gridContainer.querySelectorAll('.calendar-day-header');
  gridContainer.innerHTML = '';
  headers.forEach(header => gridContainer.appendChild(header));

  // 月の最初の日と最後の日
  const firstDay = new Date(currentYear, currentMonth - 1, 1);
  const lastDay = new Date(currentYear, currentMonth, 0);
  
  const firstDayOfWeek = firstDay.getDay(); // 0=日曜日
  const daysInMonth = lastDay.getDate();

  // 空白セルを追加（月の最初まで）
  for (let i = 0; i < firstDayOfWeek; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-day empty';
    gridContainer.appendChild(emptyCell);
  }

  // 日付セルを追加
  const today = new Date().toISOString().split('T')[0];
  console.log('今日の日付:', today);
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayCell = document.createElement('div');
    dayCell.className = 'calendar-day';

    // 今日の日付をハイライト
    if (dateStr === today) {
      dayCell.classList.add('today');
    }

    // 日付番号
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = day;
    
    // 日曜日と土曜日の色
    const dayOfWeek = new Date(dateStr).getDay();
    if (dayOfWeek === 0) {
      dayNumber.style.color = '#FF6B6B'; // 日曜日: 赤
    } else if (dayOfWeek === 6) {
      dayNumber.style.color = '#4A90E2'; // 土曜日: 青
    }
    
    dayCell.appendChild(dayNumber);

    // 星を常に表示
    const star = document.createElement('div');
    star.className = 'day-star';
    star.textContent = '★';

    // 気分記録がある場合は色付き星
    if (moodData[dateStr]) {
      console.log(`${dateStr} に気分データあり:`, moodData[dateStr]);
      const mood = moodData[dateStr].mood;
      const config = MOOD_CONFIG[mood];
      
      dayCell.classList.add('has-mood');
      star.style.color = config.color;

      // クリックで詳細表示
      dayCell.onclick = () => showModal(dateStr);
      dayCell.style.cursor = 'pointer';
    } else {
      // 気分記録がない場合は薄い白色の星
      star.style.color = 'rgba(255, 255, 255, 0.3)';
      
      // 未来の日付はさらに薄く
      const currentDate = new Date(dateStr);
      const todayDate = new Date(today);
      if (currentDate > todayDate) {
        dayCell.classList.add('future');
        star.style.color = 'rgba(255, 255, 255, 0.15)';
      }
    }
    
    dayCell.appendChild(star);
    gridContainer.appendChild(dayCell);
  }
  
  console.log('=== カレンダー描画完了 ===');
}

    // モーダルを表示
    function showModal(dateStr) {
      const data = moodData[dateStr];
      if (!data) return;

      const config = MOOD_CONFIG[data.mood];
      const date = new Date(dateStr);
      const dateText = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;

      document.getElementById('modalDate').textContent = dateText;
      document.getElementById('modalStar').textContent = '★';
      document.getElementById('modalStar').style.color = config.color;
      document.getElementById('modalMoodName').textContent = config.name;
      document.getElementById('modalNote').textContent = data.note || 'メモはありません';

      document.getElementById('modalOverlay').style.display = 'flex';
    }

    // モーダルを閉じる
    function closeModal() {
      document.getElementById('modalOverlay').style.display = 'none';
    }

    // ページ読み込み時
    window.addEventListener('load', () => {
      loadCalendar();
    });
  </script>
</body>
</html>